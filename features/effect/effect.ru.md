# Система эффектов

Реактивная система эффектов для управления иерархическим жизненным циклом, обработкой событий и отслеживанием зависимостей в приложениях.

## Обзор

Система эффектов предоставляет основу для реактивного программирования с автоматической очисткой, распространением контекста и обработкой событий. Она предназначена для создания масштабируемых приложений, где компоненты должны эффективно управлять своим жизненным циклом и зависимостями.

## Основные классы

### `EffectBase`

Абстрактный базовый класс, который предоставляет основную функциональность для всех эффектов.

**Ключевые возможности:**
- Автоматическое управление жизненным циклом с освобождением ресурсов
- Система контекстов для инъекции зависимостей
- Излучение событий с захватом и всплытием
- Отношения родитель-ребенок

**Методы:**
- `dispose(): Promise<void>` - Освобождает эффект и всех его детей
- `addContext(context: any): this` - Добавляет контекст к эффекту
- `context<T>(Context: T): InstanceType<T>` - Получает экземпляр контекста
- `emit(eventName: string, event: object): this` - Излучает событие вниз по иерархии
- `emitReversed(eventName: string, event: object): this` - Излучает событие вверх по иерархии

### `Effect`

Основной класс эффектов, который расширяет `EffectBase` управлением зависимостями.

**Конструктор:**
```typescript
// Простой эффект с коллбэком
new Effect(dep: EffectDep, host?: object)

// Эффект с коллбэком и очисткой
new Effect(
  callback: () => () => Promise<void> | void,
  dep: EffectDep,
  host?: object
)
```

**Ключевые возможности:**
- Отношения родитель-ребенок с автоматической очисткой
- Отслеживание и управление зависимостями
- Распространение контекста и управление жизненным циклом
- Автоматическое освобождение при удалении зависимостей

**Методы:**
- `addParent(parent: EffectBase): this` - Добавляет родительский эффект
- `removeParent(parent: EffectBase): this` - Удаляет родительский эффект
- `addDep(dep: EffectDep): this` - Добавляет зависимость
- `removeDep(dep: EffectDep): this` - Удаляет зависимость
- `isChildOf(parent: EffectBase): boolean` - Проверяет родительское отношение

### `EffectTree`

Корневой класс эффектов, который управляет всем деревом эффектов и предоставляет глобальную обработку событий.

**Ключевые возможности:**
- Управление кадрами анимации и таймерами
- Обработка ввода мыши, клавиатуры и геймпада
- Глобальная координация событий
- Пакетная обработка операций эффектов

**Методы регистрации событий:**
- `registerUpdateEvents({ before?, after? })` - Регистрирует события цикла обновления
- `registerMouseEvents({ before?, after? })` - Регистрирует события ввода мыши
- `registerEmitKeyboardEvents(before?, after?)` - Регистрирует события клавиатуры
- `registerGamepadEvents({ before?, after? })` - Регистрирует события геймпада
- `registerRenderEvents({ before?, after? })` - Регистрирует события цикла рендеринга

**Свойства состояния:**
- `isLeftMousePressed: boolean` - Состояние левой кнопки мыши
- `isMiddleMousePressed: boolean` - Состояние средней кнопки мыши
- `isRightMousePressed: boolean` - Состояние правой кнопки мыши
- `isPressed: Record<string, boolean>` - Состояния клавиш клавиатуры
- `gamepadStates: Record<number, Gamepad>` - Состояния подключенных геймпадов

## Определения типов

### `EffectDep`

Определяет типы зависимостей для эффектов:

```typescript
type EffectDep = EffectBase | [EffectBase, ContextConstructor]
```

### `ContextConstructor`

Тип для конструкторов контекстов, которые можно использовать с системой эффектов:

```typescript
type ContextConstructor = { new (...args: any[]): any; context: true }
```

## Примеры использования

### Создание базового эффекта

```typescript
import Effect from '@sky-modules/features/effect/Effect'
import EffectTree from '@sky-modules/features/effect/EffectTree'

// Создание корневого эффекта
const root = new EffectTree()

// Создание дочернего эффекта с очисткой
const effect = new Effect(() => {
  console.log('Эффект запущен')

  // Возврат функции очистки
  return () => {
    console.log('Эффект очищен')
  }
}, root)
```

### Система контекстов

```typescript
class MyContext {
  static context = true

  constructor(public value: string) {}
}

// Добавление контекста к эффекту
const contextInstance = new MyContext('привет')
root.addContext(contextInstance)

// Доступ к контексту в дочерних эффектах
const childEffect = new Effect(root)
const context = childEffect.context(MyContext) // Возвращает экземпляр MyContext
```

### Обработка событий

```typescript
class MyComponent {
  onUpdate(event: { dt: number }) {
    console.log('Обновление:', event.dt)
  }

  onGlobalMouseMove(event: { x: number, y: number }) {
    console.log('Мышь:', event.x, event.y)
  }
}

const component = new MyComponent()
const effect = new Effect(root, component)

// Регистрация глобальных событий
root.registerUpdateEvents()
root.registerMouseEvents()
```

### Управление зависимостями

```typescript
// Создание эффектов с зависимостями
const parentEffect = new Effect(root)
const childEffect = new Effect(parentEffect)

// Добавление дополнительных зависимостей
childEffect.addDep(someOtherEffect)

// Удаление зависимостей
childEffect.removeDep(someOtherEffect)
```

### Поддержка геймпада

```typescript
root.registerGamepadEvents({
  before: () => console.log('До обновления геймпада'),
  after: () => console.log('После обновления геймпада')
})

// Проверка состояния геймпада
const gamepad = root.getGamepad(0) // Получить первый геймпад
const isButtonPressed = root.isGamepadButtonPressed(0, 0) // Проверить кнопку A
```

## Система событий

Система эффектов предоставляет комплексную обработку событий:

### События обновления
- `beforeUpdate` - Перед обновлением кадра
- `update` - Основной цикл обновления
- `afterUpdate` - После обновления кадра

### События ввода
- `onGlobalMouseMove` - Движение мыши
- `onGlobalMouseDown` - Нажатие кнопки мыши
- `onGlobalMouseUp` - Отпускание кнопки мыши
- `onGlobalKeyDown` - Нажатие клавиши
- `onGlobalKeyUp` - Отпускание клавиши
- `onGamepadButtonDown` - Нажатие кнопки геймпада
- `onGamepadAxisMove` - Движение стика геймпада

### События рендеринга
- `beforeRender` - Перед рендерингом
- `render` - Основной цикл рендеринга
- `afterRender` - После рендеринга

## Управление жизненным циклом

Эффекты автоматически управляют своим жизненным циклом:

1. **Создание** - Эффект создается и добавляется к родителю
2. **Инициализация** - Контексты разрешаются и распространяются
3. **Активность** - Эффект получает события и обновления
4. **Освобождение** - Эффект и все дети очищаются

Система гарантирует, что:
- Дочерние эффекты освобождаются при освобождении родителей
- Контексты правильно очищаются
- Обработчики событий удаляются
- Утечки памяти предотвращаются

## Лучшие практики

1. **Всегда предоставляйте функции очистки** при создании эффектов с побочными эффектами
2. **Используйте контексты** для инъекции зависимостей вместо глобального состояния
3. **Группируйте операции** используя метод commit() для лучшей производительности
4. **Структурируйте эффекты иерархически** чтобы отражать архитектуру приложения
5. **Используйте типизированные контексты** для лучшего опыта разработки

## Потокобезопасность

Система эффектов предназначена для однопоточных сред, но предоставляет:
- Пакетные операции для предотвращения состояний гонки
- Правильный порядок освобождения для предотвращения висячих ссылок
- Захват событий для управления распространением событий